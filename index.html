<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#f8faff"/>
  <title>ScorProf — Montée/Descente</title>
  <style>
    :root{
      --color-primary:#1e40af;
      --color-primary-hover:#1e3a8a;
      --color-secondary:#059669;
      --color-secondary-hover:#047857;
      --color-success:#16a34a;
      --color-warning:#f59e0b;
      --color-danger:#dc2626;
      --color-info:#0284c7;
      --color-background:#f8fafc;
      --color-surface:#ffffff;
      --color-surface-alt:#f1f5f9;
      --color-text-primary:#0f172a;
      --color-text-secondary:#475569;
      --color-text-muted:#94a3b8;
      --color-border:#e2e8f0;
      --color-focus:#38bdf8;
      --color-court:#2563eb;
      --color-referee:#7c3aed;
      --space-xxs:4px;
      --space-xs:8px;
      --space-sm:12px;
      --space-md:16px;
      --space-lg:24px;
      --space-xl:32px;
      --space-xxl:48px;
      --radius-sm:10px;
      --radius-md:16px;
      --radius-lg:24px;
      --shadow-soft:0 12px 24px rgba(15,23,42,.08);
      --shadow-card:0 25px 70px rgba(15,23,42,.12);
      --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,"Courier New",monospace;
      --sans:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      --tap:48px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --color-background:#020617;
        --color-surface:#0b1220;
        --color-surface-alt:#111a2e;
        --color-text-primary:#f8fafc;
        --color-text-secondary:#cbd5f5;
        --color-text-muted:#94a3b8;
        --color-border:#1e293b;
        --color-primary:#60a5fa;
        --color-primary-hover:#3b82f6;
        --color-secondary:#34d399;
        --color-secondary-hover:#10b981;
        --color-court:#3b82f6;
        --color-referee:#a78bfa;
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--color-background);
      color:var(--color-text-secondary);
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      scroll-padding-top:var(--header-safe,120px);
    }
    h1,h2,h3,h4{
      margin:0;
      color:var(--color-text-primary);
      font-weight:800;
    }
    p{margin-top:0;margin-bottom:var(--space-md);color:var(--color-text-secondary)}
    .muted{color:var(--color-text-muted)}
    a{color:var(--color-primary);font-weight:600;text-decoration:none}
    a:hover{text-decoration:underline}
    :where(button,input,select,textarea){
      font-family:inherit;
      font-size:1rem;
    }
    :where(button,input,select,textarea):focus-visible{
      outline:2px solid var(--color-focus);
      outline-offset:2px;
    }
    .appShell{
      background:var(--color-background);
      min-height:100vh;
    }
    .appHeader{
      position:sticky;
      top:0;
      z-index:30;
      background:var(--color-surface);
      border-bottom:1px solid var(--color-border);
      box-shadow:0 6px 24px rgba(15,23,42,.06);
      padding:var(--space-lg) var(--space-lg) var(--space-md);
      transition:box-shadow .25s ease, transform .25s ease;
      transform:translateZ(0);
      backface-visibility:hidden;
      will-change:transform;
    }
    .appHeaderBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--space-lg);
      flex-wrap:wrap;
    }
    .appHeaderIdentity{
      display:flex;
      flex-direction:column;
      gap:var(--space-xxs);
    }
    .appName{
      font-size:clamp(1.5rem,2vw,2rem);
      color:var(--color-text-primary);
      font-weight:900;
    }
    .appSubtitle{color:var(--color-text-muted);font-size:0.95rem}
    .currentStepWrap{
      font-size:0.85rem;
      color:var(--color-text-muted);
      display:flex;
      align-items:center;
      gap:var(--space-xxs);
    }
    .currentStepWrap strong{color:var(--color-text-primary);font-weight:700}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:var(--space-xs);
      padding:var(--space-xs) var(--space-sm);
      border-radius:999px;
      border:1px solid var(--color-border);
      background:var(--color-surface-alt);
      color:var(--color-text-secondary);
      font-weight:600;
    }
    .sessionChip{
      display:flex;
      flex-direction:column;
      padding:var(--space-sm) var(--space-md);
      border:1px solid var(--color-border);
      border-radius:var(--radius-md);
      background:var(--color-surface-alt);
      min-width:200px;
    }
    .sessionChip span{font-size:0.8rem;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.08em}
    .sessionChip strong{font-size:1.1rem;color:var(--color-text-primary)}
    .headerToggle{
      width:46px;
      height:46px;
      border-radius:var(--radius-md);
      border:1px solid var(--color-border);
      background:var(--color-surface-alt);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:background .2s,color .2s,transform .2s;
    }
    .headerToggle:hover{background:var(--color-primary);color:#fff}
    .headerToggle .chevron{
      width:12px;
      height:12px;
      border-right:2px solid currentColor;
      border-bottom:2px solid currentColor;
      transform:rotate(225deg);
      transition:transform .2s ease;
    }
    .header--manual .headerToggle{
      background:var(--color-primary);
      color:#fff;
    }
    .appHeaderExpanded{
      margin-top:var(--space-md);
      display:flex;
      flex-direction:column;
      gap:var(--space-md);
      max-height:1000px;
      opacity:1;
      transform:translateY(0);
      overflow:hidden;
      transition:max-height .3s ease, opacity .25s ease, transform .25s ease;
    }
    .appHeaderStats{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(150px,1fr));
      gap:var(--space-sm);
    }
    .statCard{
      padding:var(--space-sm) var(--space-md);
      border-radius:var(--radius-md);
      background:var(--color-surface-alt);
      border:1px solid var(--color-border);
      display:flex;
      flex-direction:column;
      gap:var(--space-xxs);
    }
    .statLabel{font-size:0.8rem;color:var(--color-text-muted);text-transform:uppercase}
    .statValue{font-size:1.6rem;font-weight:800;color:var(--color-text-primary)}
    .stepperLabel{
      margin-top:var(--space-lg);
      font-size:0.9rem;
      color:var(--color-text-muted);
      text-transform:uppercase;
      letter-spacing:0.08em;
    }
    .nav{
      margin-top:var(--space-sm);
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(130px,1fr));
      gap:var(--space-sm);
      position:static;
      background:none;
      border:none;
      box-shadow:none;
      padding:0;
    }
    .navBtn{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:var(--space-xxs);
      padding:var(--space-md);
      border-radius:var(--radius-md);
      border:1px solid var(--color-border);
      background:var(--color-surface-alt);
      color:var(--color-text-secondary);
      font-weight:700;
      cursor:pointer;
      min-height:78px;
      transition:.2s ease;
    }
    .navBtn .stepStatus{font-size:0.85rem;color:var(--color-text-muted);font-weight:500}
    .navBtn.active{
      background:var(--color-primary);
      border-color:var(--color-primary);
      color:#fff;
      box-shadow:var(--shadow-soft);
    }
    .navBtn.active .stepStatus{color:rgba(255,255,255,.8)}
    .headerActions{margin-top:var(--space-sm)}
    .header--collapsed{
      padding:var(--space-sm) var(--space-lg);
      box-shadow:0 10px 35px rgba(15,23,42,.2);
    }
    .header--collapsed .appSubtitle,
    .header--collapsed .sessionChip,
    .header--collapsed .appHeaderExpanded,
    .header--collapsed .stepperLabel,
    .header--collapsed .headerActions{
      opacity:0;
      pointer-events:none;
      max-height:0;
      margin:0;
      overflow:hidden;
    }
    .header--collapsed .appHeaderExpanded{transform:translateY(-8px)}
    .header--collapsed .currentStepWrap{opacity:1}
    .header--collapsed .headerToggle .chevron{transform:rotate(45deg)}
    .app{
      max-width:1200px;
      margin:0 auto;
      padding:var(--space-xl) var(--space-lg) var(--space-xxl);
      display:flex;
      flex-direction:column;
      gap:var(--space-xl);
    }
    .grid{display:grid;gap:var(--space-lg)}
    @media(min-width:980px){.grid.cols2{grid-template-columns:1.1fr .9fr}}
    .card{
      background:var(--color-surface);
      border:1px solid var(--color-border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);
      overflow:hidden;
    }
    .card .hd{
      padding:var(--space-md);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--space-md);
      border-bottom:1px solid var(--color-border);
      background:var(--color-surface-alt);
    }
    .card .bd{padding:var(--space-md);display:flex;flex-direction:column;gap:var(--space-md)}
    .row{display:flex;gap:var(--space-sm);flex-wrap:wrap;align-items:center}
    .row.nowrap{flex-wrap:nowrap}
    label{
      font-size:0.9rem;
      font-weight:600;
      color:var(--color-text-primary);
    }
    textarea,input,select{
      width:100%;
      min-height:48px;
      border-radius:var(--radius-md);
      border:1px solid var(--color-border);
      background:var(--color-surface);
      color:var(--color-text-primary);
      padding:var(--space-sm) var(--space-md);
      transition:.2s ease;
    }
    textarea{min-height:180px;resize:vertical;line-height:1.4}
    .hint{font-size:0.85rem;color:var(--color-text-muted)}
    .mini{font-size:0.8rem;color:var(--color-text-muted);line-height:1.4}
    .btn{
      min-height:var(--tap);
      padding:0 var(--space-lg);
      border-radius:var(--radius-md);
      border:1px solid transparent;
      font-weight:700;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:var(--space-xs);
      transition:.2s ease;
    }
    .btn-primary{
      background:var(--color-primary);
      color:#fff;
    }
    .btn-primary:hover{background:var(--color-primary-hover)}
    .btn-secondary{
      background:var(--color-secondary);
      color:#fff;
    }
    .btn-secondary:hover{background:var(--color-secondary-hover)}
    .btn-danger{
      background:var(--color-danger);
      color:#fff;
    }
    .btn-danger:hover{opacity:.9}
    .btn-ghost{
      background:transparent;
      color:var(--color-text-primary);
      border-color:var(--color-border);
    }
    .btn-ghost:hover{background:var(--color-surface-alt)}
    .btn.fill{width:100%}
    .hero{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:45vh;
      text-align:center;
    }
    .heroBox{
      background:var(--color-surface);
      border:1px solid var(--color-border);
      border-radius:var(--radius-lg);
      padding:var(--space-xl) var(--space-lg);
      box-shadow:var(--shadow-card);
      max-width:520px;
      width:100%;
    }
    .heroBox .title{font-size:2.4rem;margin-bottom:var(--space-sm)}
    .courtList{display:grid;gap:var(--space-sm)}
    .court{
      background:var(--color-surface-alt);
      border:1px solid var(--color-border);
      border-radius:var(--radius-md);
      padding:var(--space-md);
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.05);
    }
    .courtTop{display:flex;align-items:center;justify-content:space-between;gap:var(--space-sm);flex-wrap:wrap}
    .courtTop .name{font-weight:800;color:var(--color-text-primary)}
    .tag{
      padding:var(--space-xxs) var(--space-sm);
      border-radius:999px;
      font-size:0.8rem;
      font-weight:600;
      border:1px solid var(--color-border);
      background:var(--color-surface);
      color:var(--color-text-secondary);
    }
    .courtTop .tag{background:rgba(37,99,235,.12);border-color:rgba(37,99,235,.2);color:var(--color-court)}
    .tag.arbTag{
      background:rgba(124,58,237,.15);
      border-color:rgba(124,58,237,.35);
      color:var(--color-referee);
    }
    .teamsRow{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--space-sm)}
    .teamScore{
      padding:var(--space-md);
      border-radius:var(--radius-md);
      border:1px solid var(--color-border);
      background:var(--color-surface);
      box-shadow:var(--shadow-soft);
    }
    .teamScore .playerName{color:var(--color-text-primary)}
    .teamScore input{
      margin-top:var(--space-sm);
      background:var(--color-surface-alt);
      border:2px solid transparent;
      border-radius:var(--radius-lg);
      font-family:var(--mono);
      font-size:2rem;
      text-align:center;
      --score-minus-color: var(--color-text-muted);
      --score-plus-color: var(--color-primary);
      padding-left:calc(var(--space-xl));
      padding-right:calc(var(--space-xl));
      background-image:
        linear-gradient(var(--score-minus-color), var(--score-minus-color)),
        linear-gradient(var(--score-plus-color), var(--score-plus-color)),
        linear-gradient(var(--score-plus-color), var(--score-plus-color));
      background-size:18px 2px, 18px 2px, 2px 18px;
      background-position:calc(var(--space-md)) center, calc(100% - var(--space-md)) center, calc(100% - var(--space-md)) center;
      background-repeat:no-repeat;
    }
    .teamScore input:focus-visible{border-color:var(--color-primary);background:var(--color-surface)}
    .warnBox{
      background:rgba(220,38,38,.12);
      border:1px solid rgba(220,38,38,.3);
      color:var(--color-danger);
      border-radius:var(--radius-md);
      padding:var(--space-sm) var(--space-md);
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--color-border);
      border-radius:var(--radius-lg);
      overflow:hidden;
    }
    .table th{
      background:var(--color-surface-alt);
      text-transform:uppercase;
      font-size:0.75rem;
      letter-spacing:0.05em;
      color:var(--color-text-muted);
    }
    .table td,.table th{padding:var(--space-sm) var(--space-md)}
    .table td{background:var(--color-surface);color:var(--color-text-primary)}
    .kpi{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:var(--space-sm);
    }
    .kpi .box{
      border:1px solid var(--color-border);
      border-radius:var(--radius-md);
      padding:var(--space-sm);
      background:var(--color-surface-alt);
      text-align:center;
    }
    .kpi .v{font-size:1.4rem;font-weight:800;color:var(--color-text-primary)}
    .kpi .l{font-size:0.75rem;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.08em}
    #timerCard{
      border:1px solid var(--color-border);
      border-radius:var(--radius-lg);
      background:var(--color-surface);
      box-shadow:var(--shadow-soft);
    }
    .timerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:var(--space-md);
      border-bottom:1px solid var(--color-border);
      background:var(--color-surface-alt);
    }
    .timerDisplay{
      font-size:3.5rem;
      font-family:var(--mono);
      font-weight:900;
      color:var(--color-text-primary);
      text-align:center;
      padding:var(--space-lg);
    }
    .timerControls{
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-sm);
      padding:var(--space-md);
      justify-content:center;
    }
    .switch{
      display:flex;
      align-items:flex-start;
      gap:var(--space-sm);
      border:1px solid var(--color-border);
      border-radius:var(--radius-md);
      padding:var(--space-sm) var(--space-md);
      background:var(--color-surface);
    }
    .switch input{
      width:22px;
      height:22px;
      flex:0 0 auto;
      margin-top:4px;
    }
    .two{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:var(--space-sm)}
    .court .row input[type=number]{
      flex:1;
      text-align:center;
      font-family:var(--mono);
      font-size:1.4rem;
    }
    .modal{
      position:fixed;
      inset:0;
      display:none;
      background:rgba(2,6,23,.75);
      padding:var(--space-md);
      z-index:60;
    }
    .modal.open{display:flex;align-items:flex-end}
    @media(min-width:720px){.modal.open{align-items:center;justify-content:center}}
    .sheet{
      width:100%;
      max-width:860px;
      background:var(--color-surface);
      border-radius:var(--radius-lg);
      border:1px solid var(--color-border);
      box-shadow:var(--shadow-card);
      overflow:hidden;
    }
    .sheet .hd{
      padding:var(--space-md);
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--color-border);
    }
    .sheet .bd{padding:var(--space-md);max-height:70vh;overflow:auto}
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:100px;
      z-index:70;
      background:var(--color-text-primary);
      color:var(--color-background);
      padding:var(--space-sm) var(--space-lg);
      border-radius:999px;
      box-shadow:var(--shadow-soft);
      display:none;
    }
    .toast.show{display:block}
    .timerPopup{
      background:var(--color-surface);
      border-radius:var(--radius-lg);
      padding:var(--space-xl);
      box-shadow:var(--shadow-card);
      color:var(--color-text-primary);
      display:flex;
      flex-direction:column;
      gap:var(--space-md);
      align-items:center;
    }
    .timerPopupDisplay{
      font-size:6rem;
      font-family:var(--mono);
      font-weight:900;
    }
    .timerPopup.fullscreen{
      width:100vw;
      height:100vh;
      border-radius:0;
      justify-content:center;
    }
    @media (prefers-reduced-motion:reduce){
      *{transition:none!important}
    }
  </style>
</head>
<body>
  <div class="appShell">
    <header class="appHeader header--auto" id="appHeader">
      <div class="appHeaderBar">
        <div class="appHeaderIdentity">
          <div class="appName">ScorProf</div>
          <div class="appSubtitle">Montée/Descente — badminton</div>
          <div class="currentStepWrap"><span>Étape :</span> <strong id="currentStepLabel">Accueil</strong></div>
        </div>
        <div class="sessionChip">
          <span>Tournoi</span>
          <strong id="tournamentName">Évaluation Bac</strong>
        </div>
        <button class="headerToggle" id="headerToggle" type="button" aria-label="Réduire le bandeau">
          <span class="chevron"></span>
        </button>
      </div>
      <div class="appHeaderExpanded">
        <div class="appHeaderStats">
          <div class="statCard">
            <span class="statLabel">Élèves</span>
            <span class="statValue" id="kpiStudents">0</span>
          </div>
          <div class="statCard">
            <span class="statLabel">Matchs</span>
            <span class="statValue" id="kpiMatches">0</span>
          </div>
          <div class="statCard">
            <span class="statLabel">Terrains</span>
            <span class="statValue" id="kpiCourts">0</span>
          </div>
          <div class="statCard">
            <span class="statLabel">Dernier match</span>
            <span class="statValue" id="kpiLast">—</span>
          </div>
        </div>
        <div class="stepperLabel">Étape actuelle</div>
        <div class="nav">
          <button class="navBtn active" data-nav="home">
            <span class="stepTitle">Accueil</span>
            <span class="stepStatus">Briefing</span>
          </button>
          <button class="navBtn" data-nav="setup">
            <span class="stepTitle">Saisie</span>
            <span class="stepStatus">Classe &amp; terrains</span>
          </button>
          <button class="navBtn" data-nav="assign">
            <span class="stepTitle">Répartition</span>
            <span class="stepStatus">Équipes &amp; arbitres</span>
          </button>
          <button class="navBtn" data-nav="matches">
            <span class="stepTitle">Matchs</span>
            <span class="stepStatus">Scores en direct</span>
          </button>
          <button class="navBtn" data-nav="results">
            <span class="stepTitle">Bilan</span>
            <span class="stepStatus">Classement</span>
          </button>
          <button class="navBtn" data-nav="doubles">
            <span class="stepTitle">Ronde italienne</span>
            <span class="stepStatus">Paires &amp; scores</span>
          </button>
        </div>
        <div class="headerActions">
          <button class="btn btn-ghost fill" id="btnOpenDoubleTab">Ouvrir Ronde italienne dans un nouvel onglet</button>
        </div>
      </div>
    </header>
    <main class="app">

    <section id="page-home" class="hero">
      <div class="heroBox">
        <div class="title">ScorProf</div>
        <p class="muted">Organise ta séance montée/descente en trois étapes simples.</p>
        <button class="btn btn-primary" id="btnStart">Démarrer</button>
      </div>
    </section>

    <section id="page-setup" style="display:none" class="grid cols2">
      <div class="card">
        <div class="hd">
          <h2>Saisie — classe &amp; configuration</h2>
          <button class="btn btn-primary" id="btnSaveSetup">Enregistrer</button>
        </div>
        <div class="bd">
          <label>Nom de la séance / tournoi</label>
          <input id="inpTournament" placeholder="Ex: Bac badminton — 8 février" />
          <div class="hint">Ce nom apparaît dans l’export CSV.</div>

          <div class="row" style="margin:12px 0">
            <button class="btn btn-danger" id="btnResetAll">Réinitialiser</button>
            <button class="btn btn-ghost" id="btnInstallTip">Astuces iPad</button>
          </div>

          <label style="margin-top:14px">Liste des élèves (1 par ligne)</label>
          <textarea id="taStudents" placeholder="Ex:
Alice
Baptiste
Camille
..."></textarea>
          <div class="hint">Astuce : tu peux coller depuis un tableau ou un document.</div>

          <div style="margin-top:10px">
            <label>Nombre de terrains (1 à 12)</label>
            <input id="inpCourts" type="number" min="1" max="12" value="8"/>
            <div class="hint">Les terrains seront nommés automatiquement : Terrain 1, Terrain 2, …</div>
          </div>

          <label style="margin-top:14px">Règles par terrain</label>
          <div class="hint">Personnalise chaque terrain : simple/ronde italienne et avec/sans arbitre.</div>
          <div id="courtConfig" class="courtList" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>Outils rapides</h2></div>
        <div class="bd">
          <div class="row">
            <button class="btn btn-ghost" id="btnAutoSingles">Tout en simple</button>
            <button class="btn btn-ghost" id="btnCenterDoubles">Ronde italienne sur tous les terrains</button>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn btn-ghost" id="btnNoUmpires">Sans arbitre partout</button>
            <button class="btn btn-ghost" id="btnYesUmpires">Avec arbitre partout</button>
          </div>
        </div>
      </div>
    </section>

    <section id="page-assign" style="display:none" class="grid cols2">
      <div class="card">
        <div class="hd">
          <h2>Répartition — montée/descente</h2>
          <div class="row">
            <button class="btn btn-ghost" id="btnAutoAssign">Remplir auto</button>
            <button class="btn btn-primary" id="btnSaveAssignments">Enregistrer</button>
          </div>
        </div>
        <div class="bd">
          <div class="muted" style="margin-bottom:10px">Affecte les élèves aux terrains. Les arbitres sont mémorisés si activés.</div>
          <div id="assignCourts" class="courtList"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>Élèves en attente</h2></div>
        <div class="bd">
          <div class="muted" id="assignPool">Configure d’abord la classe pour utiliser la répartition.</div>
        </div>
      </div>
    </section>

    <section id="page-matches" style="display:none">
      <div class="card">
        <div class="hd">
          <h2>Matchs — saisie des scores</h2>
          <div class="row nowrap">
            <button class="btn btn-danger" id="btnUndoLast">Annuler dernier match</button>
            <button class="btn btn-primary" id="btnSaveMatches">Enregistrer les matchs</button>
            <button class="btn btn-secondary" id="btnApplyRotation">Rotation suivante</button>
            <button class="btn btn-ghost" id="btnEndSession">Fin de partie</button>
            <button class="btn btn-ghost" id="btnToggleManualEdit">Édition manuelle</button>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="gap:10px; align-items:flex-start; margin-bottom:10px">
            <div class="hint" style="flex:1">
              1) Vérifie les équipes/arbitres depuis <b>Répartition</b>.<br/>
              2) Ici, tu saisis uniquement les scores.<br/>
              3) Clique <b>Enregistrer les matchs</b> puis passe à la rotation suivante.
            </div>
            <button class="btn btn-ghost" id="btnEditAssignments">Modifier la répartition</button>
          </div>

          <div class="card" style="margin-bottom:14px" id="timerCard">
            <div class="hd timerHeader">
              <h2>Chrono</h2>
              <div class="pill">Match en cours</div>
            </div>
            <div class="timerDisplay" id="timerDisplay">00:00</div>
            <div class="bd">
              <div class="two">
                <div>
                  <label>Durée (minutes)</label>
                  <input id="timerMinutes" type="number" min="0" value="5" />
                  <div class="hint">Ex : 4–6 min/match en rotation rapide.</div>
                </div>
                <div>
                  <label>Signal fin</label>
                  <select id="timerBeep">
                    <option value="1">Bip</option>
                    <option value="0">Silencieux</option>
                  </select>
                  <div class="hint">Le bip nécessite un premier clic (iOS).</div>
                </div>
              </div>
              <div class="timerControls">
                <button class="btn btn-secondary" id="timerStart">Start</button>
                <button class="btn btn-ghost" id="timerPause">Pause</button>
                <button class="btn btn-ghost" id="timerReset">Reset</button>
                <button class="btn btn-ghost" id="btnTimerPopup">Plein écran</button>
              </div>
            </div>
          </div>

          <button class="btn btn-ghost" id="btnNewRound" style="margin-bottom:10px">Ajouter une rotation manuelle</button>

          <div id="courtsLive" class="courtList"></div>

          <div class="card" id="manualAdjustSection" style="display:none;margin-top:14px">
            <div class="hd">
              <h2>Ajustements manuels</h2>
              <button class="btn btn-primary" id="btnSaveManualAdjust">Enregistrer</button>
            </div>
            <div class="bd">
              <div class="hint">Corrige la rotation directement depuis cette page si besoin.</div>
              <div id="manualAdjust" class="courtList" style="margin-top:10px"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="page-results" style="display:none" class="grid cols2">
      <div class="card">
        <div class="hd">
          <h2>Bilan — classement</h2>
          <div class="row">
            <button class="btn btn-ghost" id="btnExport">Exporter CSV</button>
          </div>
        </div>
        <div class="bd">
          <table class="table" id="tblRanking">
            <thead>
              <tr>
                <th>#</th>
                <th>Élève</th>
                <th>Perf</th>
                <th>Points</th>
                <th>Victoires</th>
                <th>Défaites</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="hint" style="margin-top:10px">
            <b>Indice de performance</b> : inspiré du système ELO (méthode de classement développée pour les échecs qui attribue plus ou moins de points selon la force de l’adversaire affronté).
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>Résumé</h2></div>
        <div class="bd">
          <p>Utilise les exports pour archiver les résultats : les élèves conservent leur indice ELO, chaque match est tracé et la différence de points reste visible même en rotation rapide.</p>
          <div class="hint">Astuce : conserve une copie CSV après chaque séance pour suivre les progrès sur le trimestre.</div>
        </div>
      </div>
    </section>

    <section id="page-doubles" style="display:none" class="grid cols2">
      <div class="card">
        <div class="hd">
          <h2>Ronde italienne — constitution des paires</h2>
          <div class="row">
            <button class="btn btn-ghost" id="btnDoubleAuto">Auto</button>
            <button class="btn btn-primary" id="btnDoubleSave">Enregistrer</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint">Associe les élèves par paire (auto puis ajuste si besoin).</div>
          <div id="doubleAssignList" class="courtList" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>Ronde italienne — résultats</h2>
          <div class="row nowrap">
            <button class="btn btn-primary" id="btnDoubleSaveMatches">Enregistrer la rotation</button>
            <button class="btn btn-secondary" id="btnDoubleRotation">Rotation suivante</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:10px">
            1) Simple 1 jusqu’à 10.<br/>
            2) Simple 2 continue jusqu’à 20.<br/>
            3) Ronde italienne jusqu’à 30 avec 2 pts d’écart.<br/>
            Gagnant monte, perdant descend (sans arbitre).
          </div>
          <div id="doubleCourts" class="courtList"></div>
        </div>
      </div>

      <div class="card" style="grid-column:1 / -1">
        <div class="hd">
          <h2>Ronde italienne — bilan</h2>
          <div class="row">
            <button class="btn btn-ghost" id="btnDoubleExport">Exporter CSV</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint">Historique des rotations ronde italienne (simples + ronde italienne).</div>
          <div id="doubleResults" class="courtList"></div>
        </div>
      </div>
    </section>
    </main>
  </div>

  <div class="modal" id="playerModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="hd">
        <div>
          <div style="font-weight:900" id="pmName">Élève</div>
          <div class="muted" id="pmSub">Détails</div>
        </div>
        <button class="btn btn-ghost" id="pmClose">Fermer</button>
      </div>
      <div class="bd">
        <div class="kpi" style="margin-bottom:12px">
          <div class="box"><div class="v" id="pmPerf">—</div><div class="l">Indice perf</div></div>
          <div class="box"><div class="v" id="pmVD">—</div><div class="l">V-D</div></div>
          <div class="box"><div class="v" id="pmPts">—</div><div class="l">Points +/-</div></div>
          <div class="box"><div class="v" id="pmRate">—</div><div class="l">%</div></div>
        </div>
        <div style="font-weight:900;margin:8px 0">Évolution perf</div>
        <canvas id="pmChart" width="900" height="260" style="max-width:100%;margin-bottom:12px"></canvas>
        <div class="hint" style="margin-bottom:12px">Indice ELO : système de classement utilisé aux échecs, qui ajuste la note selon la force de l’adversaire affronté.</div>
        <div style="font-weight:900;margin:8px 0">Matchs</div>
        <div id="pmMatches"></div>
      </div>
    </div>
  </div>

  <div class="modal timerCenter" id="timerModal" role="dialog" aria-modal="true">
    <div class="timerPopup" id="timerPopupBox">
      <div class="row" style="justify-content:space-between;width:100%">
        <h2 style="margin:0;font-size:18px">Chrono</h2>
        <div class="row" style="gap:8px">
          <button class="btn btn-ghost" id="btnTimerFullscreen">Plein écran</button>
          <button class="btn btn-ghost" id="btnTimerClose">Fermer</button>
        </div>
      </div>
      <div class="timerPopupDisplay" id="timerPopupDisplay">00:00</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
const STORE_KEY = "scorprof.v1";

const defaultState = () => ({
  tournamentName: "Évaluation Bac",
  students: [],
  courts: [],
  matches: [],
  assignments: {},
  round: 1,
  doubleAssignments: {},
  doubleMatches: [],
  doubleRound: 1
});

let state = loadState();
let setupPreview = [];
let timer = { running:false, endAt:null, remainingMs:0 };
const tournamentNameEl = document.getElementById("tournamentName");

function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return defaultState();
    return Object.assign(defaultState(), JSON.parse(raw));
  }catch(e){
    return defaultState();
  }
}
function saveState(){
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
  renderAll();
}
function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 1500);
}

function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

/** ===== Timer ===== */
const timerDisplay = document.getElementById("timerDisplay");
const timerMinutes = document.getElementById("timerMinutes");
const timerBeep = document.getElementById("timerBeep");
const timerModalEl = document.getElementById("timerModal");
const timerPopupDisplay = document.getElementById("timerPopupDisplay");
const timerPopupBox = document.getElementById("timerPopupBox");

function fmtMMSS(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}
function renderTimer(){
  const ms = timer.running ? (timer.endAt - Date.now()) : timer.remainingMs;
  timerDisplay.textContent = fmtMMSS(ms);
  timerPopupDisplay.textContent = fmtMMSS(ms);
}
function tick(){
  if(!timer.running) return;
  const left = timer.endAt - Date.now();
  if(left<=0){
    timer.running = false;
    timer.remainingMs = 0;
    renderTimer();
    if(timerBeep.value==="1"){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine"; osc.frequency.value = 880;
        gain.gain.value = 0.03;
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start();
        setTimeout(()=>{osc.stop();ctx.close();},200);
      }catch(e){}
    }
    toast("Temps écoulé");
    return;
  }
  renderTimer();
  requestAnimationFrame(tick);
}

document.getElementById("timerStart").addEventListener("click", ()=>{
  const mins = Math.max(0, Number(timerMinutes.value||0));
  if(!timer.running){
    if(timer.remainingMs<=0) timer.remainingMs = mins*60000;
    timer.endAt = Date.now() + timer.remainingMs;
    timer.running = true;
    tick();
    timerModalEl.classList.add("open");
  }
});
document.getElementById("timerPause").addEventListener("click", ()=>{
  if(timer.running){
    timer.remainingMs = Math.max(0, timer.endAt - Date.now());
    timer.running = false;
    renderTimer();
  }
});
document.getElementById("timerReset").addEventListener("click", ()=>{
  timer.running = false;
  timer.remainingMs = Math.max(0, Number(timerMinutes.value||0))*60000;
  renderTimer();
});
document.getElementById("btnTimerPopup").addEventListener("click", ()=>{
  timerModalEl.classList.add("open");
});
function exitFullscreen(){
  if(document.fullscreenElement || document.webkitFullscreenElement){
    const exit = document.exitFullscreen || document.webkitExitFullscreen;
    if(exit){
      exit.call(document).catch(()=>{});
    }
  }
}
function closeTimerModal(){
  timerModalEl.classList.remove("open");
  exitFullscreen();
}
document.getElementById("btnTimerClose").addEventListener("click", closeTimerModal);
if(timerModalEl){
  timerModalEl.addEventListener("click", (e)=>{
    if(e.target === timerModalEl){
      closeTimerModal();
    }
  });
}
document.getElementById("btnTimerFullscreen").addEventListener("click", ()=>{
  if(!timerPopupBox) return;
  const req = timerPopupBox.requestFullscreen || timerPopupBox.webkitRequestFullscreen;
  if(req){
    req.call(timerPopupBox).catch(()=>{});
  }
});
document.addEventListener("fullscreenchange", ()=>{
  if(!timerPopupBox) return;
  const isFull = document.fullscreenElement === timerPopupBox;
  timerPopupBox.classList.toggle("fullscreen", isFull);
});
document.addEventListener("webkitfullscreenchange", ()=>{
  if(!timerPopupBox) return;
  const isFull = document.webkitFullscreenElement === timerPopupBox;
  timerPopupBox.classList.toggle("fullscreen", isFull);
});
renderTimer();

/** ===== Setup ===== */
const taStudents = document.getElementById("taStudents");
const inpCourts = document.getElementById("inpCourts");
const courtConfig = document.getElementById("courtConfig");

function buildCourts(count){
  const n = Math.min(12, Math.max(1, count|0));
  const courts = [];
  for(let i=0;i<n;i++){
    courts.push({
      id: uid("court"),
      name: `Terrain ${i+1}`,
      allowDoubles: true,
      mode: "S",
      umpire: false
    });
  }
  return courts;
}

function editableCourts(){
  if(state.courts.length) return state.courts;
  if(!setupPreview.length){
    setupPreview = buildCourts(Number(inpCourts.value||8));
  }
  return setupPreview;
}

function renderCourtConfig(){
  const list = editableCourts();
  courtConfig.innerHTML = "";
  list.forEach((court, idx)=>{
    const wrapper = document.createElement("div");
    wrapper.className = "court";
    wrapper.dataset.index = idx;
    wrapper.innerHTML = `
      <div class="courtTop">
        <div class="name">${escapeHtml(court.name)}</div>
        <span class="tag">${court.allowDoubles ? "Ronde italienne possible" : "Simple uniquement"}</span>
      </div>
      <div class="two">
        <div class="switch">
          <input type="checkbox" data-act="mode" ${court.mode==="D" ? "checked": ""} ${court.allowDoubles ? "" : "disabled"}>
          <div>
            <div style="font-weight:900">Ronde italienne</div>
            <div class="mini">${court.allowDoubles ? "Active 2 vs 2" : "Interdit"}</div>
          </div>
        </div>
        <div class="switch">
          <input type="checkbox" data-act="umpire" ${court.umpire ? "checked" : ""}>
          <div>
            <div style="font-weight:900">Avec arbitre</div>
            <div class="mini">Gestion du temps / responsabilité</div>
          </div>
        </div>
      </div>
    `;
    wrapper.querySelectorAll("input[type=checkbox]").forEach(cb=>{
      cb.addEventListener("change", (e)=>{
        const targetList = editableCourts();
        const targetCourt = targetList[idx];
        if(!targetCourt) return;
        if(cb.dataset.act==="mode"){
          targetCourt.mode = cb.checked ? "D" : "S";
          if(!targetCourt.allowDoubles) targetCourt.mode = "S";
        }
        if(cb.dataset.act==="umpire"){
          targetCourt.umpire = cb.checked;
        }
        if(targetList === state.courts){
          saveState();
        }
      });
    });
    courtConfig.appendChild(wrapper);
  });
}

function handleSetupSave(){
  const names = taStudents.value.split("\n").map(s=>s.trim()).filter(Boolean);
  if(names.length===0){
    alert("Saisis au moins un élève");
    return;
  }
  const count = Math.min(12, Math.max(1, Number(inpCourts.value||8)));
  let list = editableCourts();
  if(list.length !== count){
    list = buildCourts(count);
  }
  state.students = names.map(n=>({id:uid("student"), name:n}));
  state.courts = list.map(c=>({
    id: c.id || uid("court"),
    name: c.name,
    allowDoubles: c.allowDoubles,
    mode: c.allowDoubles ? c.mode : "S",
    umpire: !!c.umpire
  }));
  setupPreview = [];
  state.assignments = {};
  state.matches = [];
  state.round = 1;
  state.doubleAssignments = {};
  state.doubleMatches = [];
  state.doubleRound = 1;
  state.tournamentName = inpTournament.value.trim() || "Évaluation Bac";
  saveState();
  toast("Saisie enregistrée");
  showPage("assign");
}

document.getElementById("btnSaveSetup").addEventListener("click", handleSetupSave);

function applyQuick(fn){
  const list = editableCourts();
  fn(list);
  if(list === state.courts){
    saveState();
  }else{
    renderCourtConfig();
  }
}

document.getElementById("btnAutoSingles").addEventListener("click", ()=>{
  applyQuick(list=>list.forEach(c=>c.mode="S"));
});
document.getElementById("btnCenterDoubles").addEventListener("click", ()=>{
  applyQuick(list=>{
    list.forEach(c=>{
      c.allowDoubles = true;
      c.mode = "D";
    });
  });
});
document.getElementById("btnNoUmpires").addEventListener("click", ()=>{
  applyQuick(list=>list.forEach(c=>c.umpire=false));
});
document.getElementById("btnYesUmpires").addEventListener("click", ()=>{
  applyQuick(list=>list.forEach(c=>c.umpire=true));
});

inpCourts.addEventListener("change", ()=>{
  if(state.courts.length===0){
    setupPreview = buildCourts(Number(inpCourts.value||8));
    renderCourtConfig();
  }
});

/** ===== Répartition ===== */
const assignCourtsEl = document.getElementById("assignCourts");
const assignPoolEl = document.getElementById("assignPool");
const btnSaveAssignments = document.getElementById("btnSaveAssignments");
const btnAutoAssign = document.getElementById("btnAutoAssign");

function getAssignment(court){
  if(!state.assignments[court.id]){
    state.assignments[court.id] = {teamA:[], teamB:[], umpire:null};
  }
  return state.assignments[court.id];
}

function studentOptionsHTML(selected){
  return state.students.map(s=>`
    <option value="${s.id}" ${s.id===selected ? "selected" : ""}>${escapeHtml(s.name)}</option>
  `).join("");
}

function renderAssignmentCards(container, {showUmpireToggle=false, forcePairs=false, source="singles"}={}){
  container.innerHTML = "";
  const used = new Set();
  const getData = source==="doubles" ? getDoubleAssign : getAssignment;
  state.courts.forEach((court, idx)=>{
    const assign = getData(court);
    (assign.teamA || []).forEach(id=>used.add(id));
    (assign.teamB || []).forEach(id=>used.add(id));
    if(source!=="doubles" && assign.umpire) used.add(assign.umpire);
    const allowDouble = forcePairs ? true : (court.allowDoubles && court.mode==="D");
    const slots = allowDouble ? 2 : 1;
    const buildTeamSelects = (teamKey, values)=>{
      if(slots===1){
        return `<select data-slot="${teamKey}0" data-court="${court.id}"><option value="">—</option>${studentOptionsHTML(values[0])}</select>`;
      }
      const items = [];
      for(let i=0;i<2;i++){
        items.push(`<select data-slot="${teamKey}${i}" data-court="${court.id}"><option value="">—</option>${studentOptionsHTML(values[i])}</select>`);
      }
      return `<div class="two">${items.join("")}</div>`;
    };
    const umpireBlock = (source==="doubles") ? "" : (court.umpire ? `<div><label>Arbitre</label><select data-slot="umpire" data-court="${court.id}"><option value="">—</option>${studentOptionsHTML(assign.umpire)}</select></div>` : "");
    const umpireToggle = showUmpireToggle ? `
      <label class="switch" style="max-width:220px;margin-left:auto">
        <input type="checkbox" data-act="toggle-umpire" data-id="${court.id}" ${court.umpire ? "checked":""}>
        <div>
          <div style="font-weight:900">Arbitre requis</div>
          <div class="mini">${court.umpire ? "Un élève arbitrera ce terrain" : "Sans arbitre"}</div>
        </div>
      </label>` : "";
    const block = document.createElement("div");
    block.className = "court";
    block.dataset.court = court.id;
    block.innerHTML = `
      <div class="courtTop">
        <div class="name">${escapeHtml(court.name)}</div>
        <span class="tag">${slots===2 ? "Ronde italienne" : "Simple"}</span>
        <span class="tag">${court.umpire ? "Avec arbitre" : "Sans arbitre"}</span>
        ${umpireToggle}
      </div>
      <div class="two">
        <div>
          <label>Équipe A</label>
          ${buildTeamSelects("a", assign.teamA)}
        </div>
        <div>
          <label>Équipe B</label>
          ${buildTeamSelects("b", assign.teamB)}
        </div>
      </div>
      ${umpireBlock}
    `;
    container.appendChild(block);
  });
  if(showUmpireToggle){
    container.querySelectorAll("[data-act=toggle-umpire]").forEach(cb=>{
      cb.addEventListener("change", ()=>{
        const id = cb.dataset.id;
        const court = state.courts.find(x=>x.id===id);
        if(!court) return;
        court.umpire = !!cb.checked;
        if(!court.umpire && state.assignments[court.id]){
          state.assignments[court.id].umpire = null;
        }
        saveState();
      });
    });
  }
  attachAssignmentSelectHandlers(container);
  return used;
}

function renderAssignmentsPage(){
  if(!assignCourtsEl) return;
  assignCourtsEl.innerHTML = "";
  if(state.students.length===0 || state.courts.length===0){
    assignCourtsEl.innerHTML = `<div class="muted">Commence par saisir la classe et configurer les terrains.</div>`;
    if(assignPoolEl) assignPoolEl.textContent = "—";
    return;
  }
  const used = renderAssignmentCards(assignCourtsEl, {showUmpireToggle:true});
  if(assignPoolEl){
    const waiting = state.students.filter(s=>!used.has(s.id));
    assignPoolEl.textContent = waiting.length ? waiting.map(s=>s.name).join(", ") : "Tous les élèves sont affectés.";
  }
}

function getDoubleAssign(court){
  if(!state.doubleAssignments[court.id]){
    state.doubleAssignments[court.id] = {teamA:[], teamB:[]};
  }
  return state.doubleAssignments[court.id];
}

function renderDoubleAssignments(){
  if(!doubleAssignList) return;
  doubleAssignList.innerHTML = "";
  if(state.students.length===0 || state.courts.length===0){
    doubleAssignList.innerHTML = `<div class="muted">Configure d’abord la classe.</div>`;
    return;
  }
  renderAssignmentCards(doubleAssignList, {showUmpireToggle:false, forcePairs:true, source:"doubles"});
}

function attachAssignmentSelectHandlers(root){
  const selects = root.querySelectorAll("select[data-slot]");
  selects.forEach(sel=>{
    sel.addEventListener("change", ()=>refreshAssignmentSelectOptions(root));
  });
  refreshAssignmentSelectOptions(root);
}

function refreshAssignmentSelectOptions(root){
  const selects = Array.from(root.querySelectorAll("select[data-slot]"));
  const currentValues = selects.map(sel=>sel.value);
  selects.forEach((sel, idx)=>{
    const selected = sel.value;
    const usedElsewhere = new Set();
    currentValues.forEach((val, j)=>{
      if(val && j!==idx) usedElsewhere.add(val);
    });
    const options = state.students.filter(s=>!usedElsewhere.has(s.id) || s.id===selected);
    const html = ['<option value="">—</option>'];
    options.forEach(s=>{
      html.push(`<option value="${s.id}" ${s.id===selected ? "selected":""}>${escapeHtml(s.name)}</option>`);
    });
    sel.innerHTML = html.join("");
    sel.value = selected;
  });
}

function collectAssignmentsFromContainer(container, {forcePairs=false, source="singles"}={}){
  const next = {};
  const used = new Set();
  const getter = source==="doubles" ? getDoubleAssign : getAssignment;
  for(const court of state.courts){
    const card = container.querySelector(`[data-court="${court.id}"]`);
    if(!card) {
      next[court.id] = getter(court);
      continue;
    }
    const slots = forcePairs ? 2 : (court.allowDoubles && court.mode==="D" ? 2 : 1);
    const teamA = [];
    const teamB = [];
    for(let i=0;i<slots;i++){
      const selA = card.querySelector(`[data-slot="a${i}"]`);
      const selB = card.querySelector(`[data-slot="b${i}"]`);
      const va = selA ? selA.value : "";
      const vb = selB ? selB.value : "";
      if(va){
        if(used.has(va)){
          alert("Un élève apparaît plusieurs fois.");
          return null;
        }
        used.add(va);
        teamA.push(va);
      }
      if(vb){
        if(used.has(vb)){
          alert("Un élève apparaît plusieurs fois.");
          return null;
        }
        used.add(vb);
        teamB.push(vb);
      }
    }
    let umpire = null;
    if(source!=="doubles" && court.umpire){
      const umpSel = card.querySelector(`[data-slot="umpire"]`);
      const vu = umpSel ? umpSel.value : "";
      if(vu){
        if(used.has(vu)){
          alert("Un élève apparaît plusieurs fois.");
          return null;
        }
        used.add(vu);
        umpire = vu;
      }
    }
    if(source==="doubles"){
      next[court.id] = {teamA, teamB};
    }else{
      next[court.id] = {teamA, teamB, umpire};
    }
  }
  return next;
}

function computeNextDoubleAssignments(){
  if(state.students.length===0 || state.courts.length===0){
    alert("Configure d’abord la classe.");
    return null;
  }
  const roundMatches = state.doubleMatches.filter(m=>m.round===state.doubleRound);
  const latestByCourt = new Map();
  roundMatches.forEach(m=>{
    const prev = latestByCourt.get(m.courtId);
    if(!prev || prev.ts < m.ts){
      latestByCourt.set(m.courtId, m);
    }
  });
  if(latestByCourt.size !== state.courts.length){
    alert("Enregistre toutes les rencontres ronde italienne avant de lancer la rotation.");
    return null;
  }
  const winners = [];
  const losers = [];
  state.courts.forEach(court=>{
    const match = latestByCourt.get(court.id);
    const winA = match.double.a > match.double.b;
    winners.push(winA ? match.pairA : match.pairB);
    losers.push(winA ? match.pairB : match.pairA);
  });
  const next = {};
  const lastIdx = state.courts.length - 1;
  state.courts.forEach((court, idx)=>{
    let pairA;
    let pairB;
    if(idx===0){
      pairA = winners[0];
    }else{
      pairA = losers[idx-1];
    }
    if(idx===lastIdx){
      pairB = losers[lastIdx];
    }else{
      pairB = winners[idx+1];
    }
    const prevDouble = state.doubleAssignments[court.id] || {teamA:[], teamB:[]};
    if(!pairA || pairA.length<2){
      pairA = prevDouble.teamA.slice();
    }
    if(!pairB || pairB.length<2){
      pairB = prevDouble.teamB.slice();
    }
    next[court.id] = {teamA: pairA, teamB: pairB};
  });
  return next;
}

btnSaveAssignments.addEventListener("click", ()=>{
  if(state.students.length===0 || state.courts.length===0){
    alert("Configure d’abord Saisie");
    return;
  }
  const result = collectAssignmentsFromContainer(assignCourtsEl);
  if(!result) return;
  state.assignments = result;
  saveState();
  toast("Répartition enregistrée");
});

btnAutoAssign.addEventListener("click", ()=>{
  if(state.students.length===0 || state.courts.length===0){
    alert("Saisis d’abord la classe");
    return;
  }
  const ids = [...state.students.map(s=>s.id)];
  let cursor = 0;
  const next = {};
  state.courts.forEach(court=>{
    const slots = court.allowDoubles && court.mode==="D" ? 2 : 1;
    const total = slots*2;
    const slice = ids.slice(cursor, cursor+total);
    cursor += total;
    next[court.id] = {
      teamA: slice.slice(0, slots),
      teamB: slice.slice(slots, total),
      umpire: court.umpire ? ids[cursor++] || null : null
    };
  });
  state.assignments = next;
  saveState();
  renderAssignmentsPage();
  toast("Répartition auto effectuée");
});

const doubleAssignList = document.getElementById("doubleAssignList");
const btnDoubleAuto = document.getElementById("btnDoubleAuto");
const btnDoubleSave = document.getElementById("btnDoubleSave");
const doubleCourtsEl = document.getElementById("doubleCourts");
const btnDoubleSaveMatches = document.getElementById("btnDoubleSaveMatches");
const btnDoubleRotation = document.getElementById("btnDoubleRotation");
const doubleResultsEl = document.getElementById("doubleResults");
const btnDoubleExport = document.getElementById("btnDoubleExport");
const btnOpenDoubleTab = document.getElementById("btnOpenDoubleTab");

if(btnDoubleAuto){
  btnDoubleAuto.addEventListener("click", ()=>{
    if(state.students.length===0 || state.courts.length===0){
      alert("Saisis d’abord la classe");
      return;
    }
    const sorted = [...state.students].sort((a,b)=>a.name.localeCompare(b.name));
    const ids = sorted.map(s=>s.id);
    let cursor = 0;
    const next = {};
    state.courts.forEach(court=>{
      const pairASize = 2;
      const pairBSize = 2;
      const pairA = ids.slice(cursor, cursor+pairASize);
      cursor += pairASize;
      const pairB = ids.slice(cursor, cursor+pairBSize);
      cursor += pairBSize;
      next[court.id] = {teamA: pairA, teamB: pairB};
    });
    state.doubleAssignments = next;
    saveState();
    renderDoubleAssignments();
    toast("Paires auto créées");
  });
}

if(btnDoubleSave){
  btnDoubleSave.addEventListener("click", ()=>{
    if(state.students.length===0 || state.courts.length===0){
      alert("Configure d’abord la classe");
      return;
    }
    const result = collectAssignmentsFromContainer(doubleAssignList, {forcePairs:true, source:"doubles"});
    if(!result) return;
    state.doubleAssignments = result;
    saveState();
    toast("Paires enregistrées");
  });
}

/** ===== Matchs ===== */
const courtsLive = document.getElementById("courtsLive");
const btnSaveMatches = document.getElementById("btnSaveMatches");
const btnEndSession = document.getElementById("btnEndSession");
const btnEditAssignments = document.getElementById("btnEditAssignments");
const btnApplyRotation = document.getElementById("btnApplyRotation");
const btnNewRound = document.getElementById("btnNewRound");
const btnUndoLast = document.getElementById("btnUndoLast");
const manualAdjustWrap = document.getElementById("manualAdjustSection");
const manualAdjustList = document.getElementById("manualAdjust");
const btnToggleManualEdit = document.getElementById("btnToggleManualEdit");
const btnSaveManualAdjust = document.getElementById("btnSaveManualAdjust");
let manualEditVisible = false;

function studentNameById(id){
  if(!id) return "";
  const student = state.students.find(s=>s.id===id);
  return student ? student.name : "";
}

function renderCourtsLive(){
  courtsLive.innerHTML = "";
  if(state.students.length===0 || state.courts.length===0){
    courtsLive.innerHTML = `<div class="muted">Configure la séance avant d’enregistrer les scores.</div>`;
    return;
  }
  state.courts.forEach(court=>{
    const card = document.createElement("div");
    card.className = "court";
    card.dataset.court = court.id;
    const assign = getAssignment(court);
    const slots = court.allowDoubles && court.mode==="D" ? 2 : 1;
    const namesA = assign.teamA.map(studentNameById);
    const namesB = assign.teamB.map(studentNameById);
    card.innerHTML = `
      <div class="courtTop">
        <div class="name">${escapeHtml(court.name)}</div>
        <span class="tag">${slots===2 ? "Ronde italienne" : "Simple"}</span>
        <span class="tag">${court.umpire ? "Avec arbitre" : "Sans arbitre"}</span>
        ${court.umpire ? `<span class="tag arbTag">Arbitre : <span class="arbName">${escapeHtml(studentNameById(assign.umpire) || "—")}</span></span>` : ""}
        <span class="tag">Rotation ${state.round}</span>
      </div>
      <div class="teamsRow">
        <div class="teamScore">
          <div class="teamLabel">Équipe A</div>
          ${(namesA.length ? namesA : ["À définir"]).map(n=>`<div class="playerName">${escapeHtml(n)}</div>`).join("")}
          <input type="number" min="0" inputmode="numeric" placeholder="Score A" data-role="scoreA" data-court="${court.id}">
        </div>
        <div class="teamScore">
          <div class="teamLabel">Équipe B</div>
          ${(namesB.length ? namesB : ["À définir"]).map(n=>`<div class="playerName">${escapeHtml(n)}</div>`).join("")}
          <input type="number" min="0" inputmode="numeric" placeholder="Score B" data-role="scoreB" data-court="${court.id}">
        </div>
      </div>
      ${assign.teamA.length===slots && assign.teamB.length===slots ? "" : `<div class='warnBox'>Affecte deux équipes complètes pour ce terrain.</div>`}
    `;
    courtsLive.appendChild(card);
  });
}

function renderManualAdjust(){
  if(!manualAdjustWrap || !manualAdjustList){
    return;
  }
  manualAdjustWrap.style.display = manualEditVisible ? "" : "none";
  if(btnToggleManualEdit){
    btnToggleManualEdit.textContent = manualEditVisible ? "Masquer édition" : "Édition manuelle";
  }
  if(!manualEditVisible) return;
  if(state.students.length===0 || state.courts.length===0){
    manualAdjustList.innerHTML = `<div class="muted">Configure la séance avant d’éditer.</div>`;
    return;
  }
  renderAssignmentCards(manualAdjustList, {showUmpireToggle:true});
}

function renderDoubleCourts(){
  if(!doubleCourtsEl){
    return;
  }
  doubleCourtsEl.innerHTML = "";
  if(state.students.length===0 || state.courts.length===0){
    doubleCourtsEl.innerHTML = `<div class="muted">Configure la séance avant de lancer la ronde italienne.</div>`;
    return;
  }
  state.courts.forEach((court, idx)=>{
    const assign = getDoubleAssign(court);
    const pairA = assign.teamA.map(studentNameById);
    const pairB = assign.teamB.map(studentNameById);
    const [a1="", a2=""] = pairA;
    const [b1="", b2=""] = pairB;
    const block = document.createElement("div");
    block.className = "court";
    block.dataset.court = court.id;
    block.innerHTML = `
      <div class="courtTop">
        <div class="name">${escapeHtml(court.name)}</div>
        <span class="tag">Rotation ${state.doubleRound}</span>
      </div>
      <div class="two">
        <div>
          <label>Simple 1 (10)</label>
          <div class="mini">${escapeHtml(a1 || "Joueur A1")} vs ${escapeHtml(b1 || "Joueur B1")}</div>
          <div class="row">
            <input type="number" min="0" max="10" placeholder="A" data-phase="s1a" data-court="${court.id}">
            <input type="number" min="0" max="10" placeholder="B" data-phase="s1b" data-court="${court.id}">
          </div>
        </div>
        <div>
          <label>Simple 2 (20)</label>
          <div class="mini">${escapeHtml(a2 || "Joueur A2")} vs ${escapeHtml(b2 || "Joueur B2")} (scores cumulés)</div>
          <div class="row">
            <input type="number" min="0" placeholder="A" data-phase="s2a" data-court="${court.id}">
            <input type="number" min="0" placeholder="B" data-phase="s2b" data-court="${court.id}">
          </div>
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Ronde italienne (>=30, 2 pts écart)</label>
        <div class="mini">${escapeHtml((pairA && pairA.join(" + ")) || "Équipe A")} vs ${escapeHtml((pairB && pairB.join(" + ")) || "Équipe B")} (scores cumulés)</div>
        <div class="row">
          <input type="number" min="0" placeholder="A" data-phase="doba" data-court="${court.id}">
          <input type="number" min="0" placeholder="B" data-phase="dobb" data-court="${court.id}">
        </div>
      </div>
    `;
    doubleCourtsEl.appendChild(block);
  });
}

function collectMatchData(court, card){
  const inputA = card.querySelector(`[data-role="scoreA"][data-court="${court.id}"]`);
  const inputB = card.querySelector(`[data-role="scoreB"][data-court="${court.id}"]`);
  const scoreA = Number(inputA ? inputA.value : "");
  const scoreB = Number(inputB ? inputB.value : "");
  if(!Number.isFinite(scoreA) || !Number.isFinite(scoreB)){
    throw new Error(`Scores invalides sur ${court.name}`);
  }
  const assign = getAssignment(court);
  const slots = court.allowDoubles && court.mode==="D" ? 2 : 1;
  if(assign.teamA.length !== slots || assign.teamB.length !== slots){
    throw new Error(`Répartition incomplète sur ${court.name}`);
  }
  return {teamA:[...assign.teamA], teamB:[...assign.teamB], scoreA:scoreA|0, scoreB:scoreB|0, umpire:assign.umpire};
}

function collectDoubleMatch(court, block){
  const assign = getDoubleAssign(court);
  if(assign.teamA.length<2 || assign.teamB.length<2){
    throw new Error(`Paires incomplètes sur ${court.name}`);
  }
  const read = phase => {
    const input = block.querySelector(`[data-phase="${phase}"][data-court="${court.id}"]`);
    const raw = input ? input.value.trim() : "";
    if(!raw && raw !== "0"){
      throw new Error(`Complète les scores sur ${court.name}`);
    }
    const num = Number(raw);
    if(!Number.isFinite(num)){
      throw new Error(`Score invalide sur ${court.name}`);
    }
    return num;
  };
  const val = phase => read(phase);
  const s1a = val("s1a");
  const s1b = val("s1b");
  const s2a = val("s2a");
  const s2b = val("s2b");
  const doba = val("doba");
  const dobb = val("dobb");
  if(!Number.isFinite(s1a) || !Number.isFinite(s1b) || !Number.isFinite(s2a) || !Number.isFinite(s2b) || !Number.isFinite(doba) || !Number.isFinite(dobb)){
    throw new Error(`Scores invalides sur ${court.name}`);
  }
  if(Math.max(s1a, s1b) !== 10){
    throw new Error(`Simple 1 doit se terminer à 10 sur ${court.name}`);
  }
  if(s2a < s1a || s2b < s1b || Math.max(s2a, s2b) !== 20){
    throw new Error(`Simple 2 doit poursuivre jusqu’à 20 (cumul) sur ${court.name}`);
  }
  const doubleTarget = Math.max(doba, dobb);
  if(doubleTarget < 30){
    throw new Error(`La ronde italienne doit atteindre au moins 30 points sur ${court.name}`);
  }
  if(Math.abs(doba - dobb) < 2){
    throw new Error(`La ronde italienne doit se terminer avec 2 points d’écart sur ${court.name}`);
  }
  if(doba < s2a || dobb < s2b){
    throw new Error(`La ronde italienne doit reprendre les scores cumulés de ${court.name}`);
  }
  return {
    simple1:{a:s1a,b:s1b},
    simple2:{a:s2a,b:s2b},
    double:{a:doba,b:dobb},
    pairA:[...assign.teamA],
    pairB:[...assign.teamB]
  };
}

btnSaveMatches.addEventListener("click", ()=>{
  if(state.courts.length===0){
    alert("Aucun terrain configuré");
    return;
  }
  const payloads = [];
  try{
    state.courts.forEach(court=>{
      const card = courtsLive.querySelector(`[data-court="${court.id}"]`);
      if(!card) return;
      const inputA = card.querySelector(`[data-role="scoreA"][data-court="${court.id}"]`);
      const inputB = card.querySelector(`[data-role="scoreB"][data-court="${court.id}"]`);
      const scoreA = inputA ? inputA.value.trim() : "";
      const scoreB = inputB ? inputB.value.trim() : "";
      if(!scoreA && !scoreB) return;
      payloads.push({court, card, data:collectMatchData(court, card)});
    });
  }catch(err){
    alert(err.message);
    return;
  }
  if(payloads.length===0){
    toast("Aucun score saisi");
    return;
  }
  payloads.forEach(({court, card, data})=>{
    state.matches.push({
      id: uid("m"),
      ts: Date.now(),
      courtId: court.id,
      mode: court.allowDoubles && court.mode==="D" ? "D" : "S",
      umpire: court.umpire,
      teamA: data.teamA,
      teamB: data.teamB,
      scoreA: data.scoreA,
      scoreB: data.scoreB,
      round: state.round
    });
    card.querySelector(`[data-role="scoreA"][data-court="${court.id}"]`).value = "";
    card.querySelector(`[data-role="scoreB"][data-court="${court.id}"]`).value = "";
  });
  saveState();
  toast("Matchs enregistrés");
});

btnEndSession.addEventListener("click", ()=>showPage("results"));
btnEditAssignments.addEventListener("click", ()=>showPage("assign"));
btnApplyRotation.addEventListener("click", ()=>{
  runAutoRotation();
});
btnNewRound.addEventListener("click", ()=>{
  state.round += 1;
  saveState();
  toast("Nouvelle rotation créée");
});
btnUndoLast.addEventListener("click", ()=>{
  if(state.matches.length===0) return toast("Aucun match");
  state.matches.pop();
  saveState();
  toast("Dernier match annulé");
});

if(btnToggleManualEdit){
  btnToggleManualEdit.addEventListener("click", ()=>{
    manualEditVisible = !manualEditVisible;
    renderManualAdjust();
  });
}
if(btnSaveManualAdjust){
  btnSaveManualAdjust.addEventListener("click", ()=>{
    if(!manualAdjustList){
      toast("Rien à enregistrer");
      return;
    }
    const result = collectAssignmentsFromContainer(manualAdjustList);
    if(!result) return;
    state.assignments = result;
    saveState();
    toast("Ajustements enregistrés");
    renderManualAdjust();
  });
}

function runAutoRotation(){
  const next = computeNextAssignments();
  if(!next) return false;
  state.assignments = next;
  state.round += 1;
  saveState();
  toast("Rotation suivante prête");
  return true;
}

function computeNextAssignments(){
  if(state.students.length===0 || state.courts.length===0){
    alert("Configure d’abord les élèves et terrains.");
    return null;
  }
  const roundToUse = state.round;
  const matches = state.matches.filter(m=>m.round===roundToUse);
  const latestByCourt = new Map();
  matches.forEach(m=>{
    const prev = latestByCourt.get(m.courtId);
    if(!prev || prev.ts < m.ts){
      latestByCourt.set(m.courtId, m);
    }
  });
  if(latestByCourt.size !== state.courts.length){
    alert("Enregistre les scores de tous les terrains avant d’appliquer la rotation.");
    return null;
  }
  const winners = [];
  const losers = [];
  state.courts.forEach((court, idx)=>{
    const match = latestByCourt.get(court.id);
    const aWin = match.scoreA >= match.scoreB;
    winners[idx] = (aWin ? match.teamA : match.teamB).slice();
    losers[idx]  = (aWin ? match.teamB : match.teamA).slice();
  });
  const used = new Set();
  const fallbackPool = state.students.map(s=>s.id);
  const next = {};

  const pickFallback = (blocked=new Set())=>{
    return fallbackPool.find(id=>!used.has(id) && !blocked.has(id));
  };

  const buildTeam = (primary, size, blocked=new Set(), extras=[])=>{
    const team = [];
    const localBlocked = new Set(blocked);
    const push = (id)=>{
      if(!id || used.has(id) || localBlocked.has(id)) return;
      team.push(id);
      used.add(id);
      localBlocked.add(id);
    };
    primary.forEach(push);
    if(team.length < size){
      extras.forEach(push);
    }
    while(team.length < size){
      const extra = pickFallback(localBlocked);
      if(!extra) break;
      push(extra);
    }
    return team.slice(0, size);
  };

  const totalCourts = state.courts.length;
  state.courts.forEach((court, idx)=>{
    const perTeam = (court.allowDoubles && court.mode==="D") ? 2 : 1;
    const hasLowerCourt = idx < totalCourts-1;
    let fromAbove = [];
    if(idx===0){
      fromAbove = (winners[0] || []).slice();
    }else{
      fromAbove = (losers[idx-1] || []).slice();
    }
    if(fromAbove.length===0){
      fromAbove = (getAssignment(court).teamA || []).slice();
    }
    let fromBelow = [];
    if(idx === totalCourts-1){
      fromBelow = (losers[idx] || []).slice();
    }else{
      fromBelow = (winners[idx+1] || []).slice();
    }
    if(fromBelow.length===0){
      fromBelow = (getAssignment(court).teamB || []).slice();
    }
    const prevAssign = getAssignment(court);
    const prevArb = prevAssign.umpire || null;
    let umpire = null;
    if(court.umpire){
      if(hasLowerCourt && fromBelow.length){
        umpire = fromBelow.shift();
      }else if(prevArb){
        umpire = prevArb;
      }else if(fromAbove.length){
        umpire = fromAbove.shift();
      }
      if(!umpire){
        const backup = pickFallback();
        if(backup){
          umpire = backup;
          used.add(backup);
        }
      }else{
        used.add(umpire);
      }
      if(prevArb && prevArb !== umpire){
        fromBelow.push(prevArb);
      }
    }
    const blockersA = new Set(umpire ? [umpire] : []);
    const teamA = buildTeam(fromAbove, perTeam, blockersA, prevAssign.teamA || []);
    const blockersB = new Set([...(umpire ? [umpire] : []), ...teamA]);
    const teamB = buildTeam(fromBelow, perTeam, blockersB, prevAssign.teamB || []);
    next[court.id] = {teamA, teamB, umpire};
  });
  return next;
}

/** ===== Résultats ===== */
const tblRankingBody = document.querySelector("#tblRanking tbody");
const playerModal = document.getElementById("playerModal");
const pmMatches = document.getElementById("pmMatches");
const pmChart = document.getElementById("pmChart");
const pmClose = document.getElementById("pmClose");

pmClose.addEventListener("click", ()=>playerModal.classList.remove("open"));
playerModal.addEventListener("click", (e)=>{
  if(e.target===playerModal) playerModal.classList.remove("open");
});

function computeRatings(){
  const rating = new Map();
  const history = new Map();
  const stats = new Map();
  state.students.forEach(s=>{
    rating.set(s.id, 1000);
    history.set(s.id, [{ts:0,r:1000}]);
    stats.set(s.id, {w:0,l:0,pf:0,pa:0});
  });
  const K = 24;
  const ordered = [...state.matches].sort((a,b)=>a.ts-b.ts);
  ordered.forEach(m=>{
    const ra = m.teamA.reduce((acc,id)=>acc + (rating.get(id)||1000),0)/m.teamA.length;
    const rb = m.teamB.reduce((acc,id)=>acc + (rating.get(id)||1000),0)/m.teamB.length;
    const expectedA = 1/(1+Math.pow(10,(rb-ra)/400));
    const expectedB = 1-expectedA;
    const aWin = m.scoreA > m.scoreB;
    const deltaA = Math.round(K*((aWin?1:0) - expectedA));
    const deltaB = Math.round(K*((aWin?0:1) - expectedB));
    m.teamA.forEach(id=>{
      rating.set(id, (rating.get(id)||1000) + deltaA);
      history.get(id).push({ts:m.ts, r:rating.get(id)});
      const st = stats.get(id);
      st.pf += m.scoreA; st.pa += m.scoreB;
      if(aWin) st.w += 1; else st.l += 1;
    });
    m.teamB.forEach(id=>{
      rating.set(id, (rating.get(id)||1000) + deltaB);
      history.get(id).push({ts:m.ts, r:rating.get(id)});
      const st = stats.get(id);
      st.pf += m.scoreB; st.pa += m.scoreA;
      if(!aWin) st.w += 1; else st.l += 1;
    });
  });
  return {rating, stats, history};
}

function renderResults(){
  if(!tblRankingBody) return;
  tblRankingBody.innerHTML = "";
  document.getElementById("kpiStudents").textContent = state.students.length;
  document.getElementById("kpiMatches").textContent = state.matches.length;
  document.getElementById("kpiCourts").textContent = state.courts.length;
  document.getElementById("kpiLast").textContent = state.matches.length ? new Date(state.matches[state.matches.length-1].ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}) : "—";

  if(state.students.length===0){
    tblRankingBody.innerHTML = `<tr><td colspan="5" class="muted">Aucun élève. Va dans Saisie.</td></tr>`;
    return;
  }
  const {rating, stats} = computeRatings();
  const rows = state.students.map(s=>{
    const st = stats.get(s.id) || {w:0,l:0,pf:0,pa:0};
    return {
      id: s.id,
      name: s.name,
      perf: rating.get(s.id) || 1000,
      w: st.w,
      l: st.l,
      pf: st.pf,
      pa: st.pa
    };
  }).sort((a,b)=>b.perf - a.perf);

  rows.forEach((r, idx)=>{
    const tr = document.createElement("tr");
    tr.className = "clickRow";
    const diff = r.pf - r.pa;
    tr.innerHTML = `
      <td class="rank">${idx+1}</td>
      <td style="font-weight:900">${escapeHtml(r.name)}</td>
      <td class="rank">${r.perf}</td>
      <td class="rank">${r.pf} <span class="muted">(${diff>=0?"+":""}${diff})</span></td>
      <td>${r.w}</td>
      <td>${r.l}</td>
    `;
    tr.addEventListener("click", ()=>openPlayerModal(r));
    tblRankingBody.appendChild(tr);
  });
}

function renderDoubleResults(){
  if(!doubleResultsEl){
    return;
  }
  if(state.doubleMatches.length===0){
    doubleResultsEl.innerHTML = `<div class="muted">Aucun match de ronde italienne pour l’instant.</div>`;
    return;
  }
  const rows = state.doubleMatches.slice().sort((a,b)=>b.ts-a.ts);
  const header = `<table class="table"><thead><tr><th>Rot.</th><th>Terrain</th><th>Simple 1</th><th>Simple 2</th><th>Ronde italienne</th></tr></thead><tbody>`;
  const body = rows.map(match=>{
    const court = state.courts.find(c=>c.id===match.courtId);
    const pairAList = (match.pairA || []).map(studentNameById);
    const pairBList = (match.pairB || []).map(studentNameById);
    const [a1,a2] = pairAList;
    const [b1,b2] = pairBList;
    const s1 = `${escapeHtml(a1||"")} vs ${escapeHtml(b1||"")} — ${match.simple1.a}-${match.simple1.b}`;
    const s2 = `${escapeHtml(a2||"")} vs ${escapeHtml(b2||"")} — ${match.simple2.a}-${match.simple2.b}`;
    const dbl = `${escapeHtml(pairAList.join(" + ")||"")} vs ${escapeHtml(pairBList.join(" + ")||"")} — ${match.double.a}-${match.double.b}`;
    return `<tr>
      <td class="rank">${match.round}</td>
      <td>${escapeHtml(court ? court.name : "Terrain")}</td>
      <td>${s1}</td>
      <td>${s2}</td>
      <td>${dbl}</td>
    </tr>`;
  }).join("");
  doubleResultsEl.innerHTML = header + body + "</tbody></table>";
}

function openPlayerModal(row){
  const { rating, stats, history } = computeRatings();
  const stat = stats.get(row.id) || {w:0,l:0,pf:0,pa:0};
  document.getElementById("pmName").textContent = row.name;
  document.getElementById("pmSub").textContent = `${state.matches.length} match(s)`;
  const perf = rating.get(row.id) || row.perf;
  document.getElementById("pmPerf").textContent = perf;
  document.getElementById("pmVD").textContent = `${stat.w}-${stat.l}`;
  const diff = stat.pf - stat.pa;
  document.getElementById("pmPts").textContent = `${stat.pf}-${stat.pa} (${diff>=0?"+":""}${diff})`;
  const total = stat.w + stat.l;
  document.getElementById("pmRate").textContent = total ? `${Math.round((stat.w/total)*100)}%` : "—";
  const series = history.get(row.id) || [{ts:0,r:perf}];
  drawPlayerChart(series);

  const matches = state.matches.filter(m=>m.teamA.includes(row.id) || m.teamB.includes(row.id)).sort((a,b)=>b.ts-a.ts);
  if(matches.length===0){
    pmMatches.innerHTML = `<div class="muted">Aucun match pour cet élève.</div>`;
  }else{
    pmMatches.innerHTML = matches.map(m=>{
      const aNames = m.teamA.map(studentNameById).join(" + ");
      const bNames = m.teamB.map(studentNameById).join(" + ");
      const isA = m.teamA.includes(row.id);
      const myScore = isA ? m.scoreA : m.scoreB;
      const opScore = isA ? m.scoreB : m.scoreA;
      const win = myScore > opScore;
    const matchCourt = state.courts.find(c=>c.id===m.courtId);
    const courtName = matchCourt ? matchCourt.name : "Terrain";
      return `
        <div class="court modalMatch">
          <div class="courtTop">
            <div class="name">${escapeHtml(courtName)}</div>
            <span class="tag">Rot. ${m.round}</span>
            <span class="tag">${m.mode==="D"?"Ronde italienne":"Simple"}</span>
          </div>
          <div>${escapeHtml(aNames)} vs ${escapeHtml(bNames)}</div>
          <div class="hint" style="margin-top:6px">${win?"Victoire":"Défaite"} — ${myScore}-${opScore}</div>
        </div>`;
    }).join("");
  }
  playerModal.classList.add("open");
}

function drawPlayerChart(series){
  if(!pmChart) return;
  const ctx = pmChart.getContext("2d");
  const W = pmChart.width;
  const H = pmChart.height;
  ctx.clearRect(0,0,W,H);
  if(!series.length){
    ctx.fillStyle = "#fff";
    ctx.font = "14px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText("Pas de données", 10, H/2);
    return;
  }
  const values = series.map(p=>p.r);
  const min = Math.min(...values, 900);
  const max = Math.max(...values, 1100);
  const pad = 30;
  ctx.strokeStyle = "rgba(255,255,255,.25)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, pad);
  ctx.lineTo(pad, H-pad);
  ctx.lineTo(W-pad, H-pad);
  ctx.stroke();
  const toX = idx => pad + (W - pad*2) * (idx/(Math.max(1, series.length-1)));
  const toY = val => {
    if(max===min) return H/2;
    return pad + (H - pad*2) * (1 - (val - min)/(max - min));
  };
  ctx.strokeStyle = "#66e3ff";
  ctx.lineWidth = 3;
  ctx.beginPath();
  series.forEach((point, idx)=>{
    const x = toX(idx);
    const y = toY(point.r);
    if(idx===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.fillStyle = "#9bff8a";
  series.forEach((point, idx)=>{
    const x = toX(idx);
    const y = toY(point.r);
    ctx.beginPath();
    ctx.arc(x,y,4,0,Math.PI*2);
    ctx.fill();
  });
}

/** ===== Export simple ===== */
document.getElementById("btnExport").addEventListener("click", ()=>{
  if(state.students.length===0){
    alert("Aucun élève");
    return;
  }
  const { rating, stats } = computeRatings();
  const studentsRows = [["tournament","student_id","nom","perf"]];
  state.students.forEach(s=>{
    studentsRows.push([state.tournamentName, s.id, s.name, rating.get(s.id) || 1000]);
  });
  downloadCSV("eleves.csv", studentsRows);

  const matchesRows = [["tournament","match_id","timestamp","round","court","mode","umpire","teamA","teamB","scoreA","scoreB"]];
  state.matches.forEach(m=>{
    const courtEntry = state.courts.find(c=>c.id===m.courtId);
    const courtName = courtEntry ? courtEntry.name : "";
    const teamA = m.teamA.map(studentNameById).join(" + ");
    const teamB = m.teamB.map(studentNameById).join(" + ");
    matchesRows.push([
      state.tournamentName,
      m.id,
      new Date(m.ts).toISOString(),
      m.round,
      courtName,
      m.mode==="D" ? "ronde italienne" : "simple",
      m.umpire ? "avec arbitre" : "sans arbitre",
      teamA,
      teamB,
      m.scoreA,
      m.scoreB
    ]);
  });
  downloadCSV("matchs.csv", matchesRows);

  const bilanRows = [["tournament","student_id","nom","perf","wins","losses","points_for","points_against","diff"]];
  state.students.forEach(s=>{
    const st = stats.get(s.id) || {w:0,l:0,pf:0,pa:0};
    bilanRows.push([
      state.tournamentName,
      s.id,
      s.name,
      rating.get(s.id) || 1000,
      st.w,
      st.l,
      st.pf,
      st.pa,
      st.pf - st.pa
    ]);
  });
  downloadCSV("bilan.csv", bilanRows);
  toast("CSV exportés");
});

if(btnDoubleExport){
  btnDoubleExport.addEventListener("click", ()=>{
    if(state.doubleMatches.length===0){
      alert("Aucun match de ronde italienne");
      return;
    }
    const rows = [["tournament","match_id","round","court","simple1","simple2","ronde_italienne","pairA","pairB"]];
    state.doubleMatches.forEach(m=>{
      const courtEntry = state.courts.find(c=>c.id===m.courtId);
      const courtName = courtEntry ? courtEntry.name : "";
      const pairA = m.pairA.map(studentNameById).join(" + ");
      const pairB = m.pairB.map(studentNameById).join(" + ");
      const simple1 = `${studentNameById(m.pairA[0])} vs ${studentNameById(m.pairB[0])} ${m.simple1.a}-${m.simple1.b}`;
      const simple2 = `${studentNameById(m.pairA[1])} vs ${studentNameById(m.pairB[1])} ${m.simple2.a}-${m.simple2.b}`;
      const dbl = `${pairA} vs ${pairB} ${m.double.a}-${m.double.b}`;
      rows.push([state.tournamentName, m.id, m.round, courtName, simple1, simple2, dbl, pairA, pairB]);
    });
    downloadCSV("ronde-italienne.csv", rows);
    toast("CSV ronde italienne exporté");
  });
}
if(btnDoubleSaveMatches && doubleCourtsEl){
  btnDoubleSaveMatches.addEventListener("click", ()=>{
    if(state.courts.length===0){
      alert("Aucun terrain configuré");
      return;
    }
    const payloads = [];
    try{
      state.courts.forEach(court=>{
        const block = doubleCourtsEl.querySelector(`[data-court="${court.id}"]`);
        if(!block) return;
        const hasValue = ["s1a","s1b","s2a","s2b","doba","dobb"].some(phase=>{
          const input = block.querySelector(`[data-phase="${phase}"][data-court="${court.id}"]`);
          return input && input.value.trim() !== "";
        });
        if(!hasValue) return;
        const data = collectDoubleMatch(court, block);
        payloads.push({court, block, data});
      });
    }catch(err){
      alert(err.message);
      return;
    }
    if(payloads.length===0){
      toast("Aucun score saisi");
      return;
    }
    payloads.forEach(({court, block, data})=>{
      state.doubleMatches.push({
        id: uid("dm"),
        ts: Date.now(),
        courtId: court.id,
        round: state.doubleRound,
        pairA: data.pairA,
        pairB: data.pairB,
        simple1: data.simple1,
        simple2: data.simple2,
        double: data.double
      });
      ["s1a","s1b","s2a","s2b","doba","dobb"].forEach(phase=>{
        const input = block.querySelector(`[data-phase="${phase}"][data-court="${court.id}"]`);
        if(input) input.value = "";
      });
    });
    saveState();
    toast("Rotation ronde italienne enregistrée");
  });
}

if(btnDoubleRotation){
  btnDoubleRotation.addEventListener("click", ()=>{
    const next = computeNextDoubleAssignments();
    if(!next) return;
    state.doubleAssignments = next;
    state.doubleRound += 1;
    saveState();
    toast("Rotation ronde italienne prête");
  });
}
function downloadCSV(filename, rows){
  const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  setTimeout(()=>{
    URL.revokeObjectURL(link.href);
    link.remove();
  }, 0);
}

function csvEscape(value){
  const str = String(value ?? "");
  if(/[",\n]/.test(str)){
    return `"${str.replace(/"/g,'""')}"`;
  }
  return str;
}

/** ===== NAV + Modes ===== */
const navButtons = document.querySelectorAll(".navBtn");
const currentStepLabelEl = document.getElementById("currentStepLabel");
const appHeaderEl = document.getElementById("appHeader");
const headerToggleBtn = document.getElementById("headerToggle");
const STEP_LABELS = {
  home:"Accueil",
  setup:"Saisie",
  assign:"Répartition",
  matches:"Matchs",
  results:"Bilan",
  doubles:"Ronde italienne"
};
const HEADER_COLLAPSE_KEY = "scorprof.headerCollapsed";
const HEADER_MODE_KEY = "scorprof.headerMode";
const SCROLL_COLLAPSE = 140;
const SCROLL_EXPAND = 60;
const MIN_SCROLL_DELTA = 12;
const COLLAPSE_LOCK_MS = 240;
let headerCollapsed = localStorage.getItem(HEADER_COLLAPSE_KEY) === "true";
let headerMode = localStorage.getItem(HEADER_MODE_KEY) === "manual" ? "manual" : "auto";
let latestScrollY = window.scrollY;
let lastScrollY = window.scrollY;
let lastHeaderToggleTs = 0;
let scrollTicking = false;

function applyHeaderState(){
  if(!appHeaderEl) return;
  appHeaderEl.classList.toggle("header--collapsed", headerCollapsed);
  appHeaderEl.classList.toggle("header--manual", headerMode==="manual");
  appHeaderEl.classList.toggle("header--auto", headerMode!=="manual");
  if(headerToggleBtn){
    headerToggleBtn.setAttribute("aria-label", headerCollapsed ? "Déplier le bandeau" : "Réduire le bandeau");
  }
  updateHeaderOffset();
}
function setHeaderCollapsed(value){
  if(headerCollapsed === value) return;
  headerCollapsed = value;
  localStorage.setItem(HEADER_COLLAPSE_KEY, headerCollapsed ? "true" : "false");
  applyHeaderState();
  lastHeaderToggleTs = performance.now();
}
function setHeaderMode(mode){
  if(headerMode === mode) return;
  headerMode = mode;
  localStorage.setItem(HEADER_MODE_KEY, headerMode);
  applyHeaderState();
}
function updateHeaderOffset(){
  if(!appHeaderEl) return;
  const height = appHeaderEl.offsetHeight || 0;
  document.documentElement.style.setProperty("--header-safe", `${height + 16}px`);
}
function processHeaderScroll(force=false){
  scrollTicking = false;
  if(headerMode==="manual") return;
  const currentY = latestScrollY;
  const delta = currentY - lastScrollY;
  const absDelta = Math.abs(delta);
  if(!force && absDelta < MIN_SCROLL_DELTA){
    return;
  }
  const now = performance.now();
  if(!force && now - lastHeaderToggleTs < COLLAPSE_LOCK_MS){
    lastScrollY = currentY;
    return;
  }
  if(currentY <= SCROLL_EXPAND){
    setHeaderCollapsed(false);
  }else if(delta < 0){
    setHeaderCollapsed(false);
  }else if(delta > 0 && currentY >= SCROLL_COLLAPSE){
    setHeaderCollapsed(true);
  }
  lastScrollY = currentY;
}
function evaluateHeaderScroll(force=false){
  if(headerMode==="manual") return;
  latestScrollY = window.scrollY;
  if(force){
    lastHeaderToggleTs = performance.now() - COLLAPSE_LOCK_MS;
    processHeaderScroll(true);
    return;
  }
  if(!scrollTicking){
    scrollTicking = true;
    requestAnimationFrame(()=>processHeaderScroll());
  }
}
function onHeaderScroll(){
  if(headerMode==="manual" || scrollTicking) return;
  latestScrollY = window.scrollY;
  scrollTicking = true;
  requestAnimationFrame(()=>processHeaderScroll());
}
window.addEventListener("scroll", onHeaderScroll, {passive:true});
if(headerToggleBtn){
  headerToggleBtn.addEventListener("click", ()=>{
    if(headerMode==="auto"){
      setHeaderMode("manual");
      setHeaderCollapsed(!headerCollapsed);
    }else{
      setHeaderCollapsed(!headerCollapsed);
      setHeaderMode("auto");
      evaluateHeaderScroll(true);
    }
  });
}
window.addEventListener("resize", updateHeaderOffset);
if(appHeaderEl){
  appHeaderEl.addEventListener("transitionend", updateHeaderOffset);
}
applyHeaderState();
if(headerMode==="auto"){
  evaluateHeaderScroll(true);
}

navButtons.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    navButtons.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    showPage(btn.dataset.nav);
  });
});

function updateCurrentStepLabel(name){
  if(currentStepLabelEl){
    currentStepLabelEl.textContent = STEP_LABELS[name] || name;
  }
}
function showPage(name){
  ["home","setup","assign","matches","results","doubles"].forEach(p=>{
    document.getElementById(`page-${p}`).style.display = (p===name)?"":"none";
  });
  navButtons.forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.nav===name);
  });
  updateCurrentStepLabel(name);
  renderAll();
}

document.getElementById("btnStart").addEventListener("click", ()=>showPage("setup"));
document.getElementById("btnEndSession").addEventListener("click", ()=>showPage("results"));

document.getElementById("btnResetAll").addEventListener("click", ()=>{
  if(confirm("Effacer toutes les données ?")){
    state = defaultState();
    setupPreview = [];
    saveState();
    toast("Données réinitialisées");
    showPage("setup");
  }
});

document.getElementById("btnInstallTip").addEventListener("click", ()=>{
  alert("iPad : Safari → Partager → “Sur l’écran d’accueil”. L’application fonctionne hors-ligne.");
});
if(btnOpenDoubleTab){
  btnOpenDoubleTab.addEventListener("click", ()=>{
    const url = new URL(window.location.href);
    url.hash = "doubles";
    window.open(url.toString(), "_blank");
  });
}

/** ===== Render ===== */
function escapeHtml(str){
  return (str ?? "").replace(/[&<>"']/g, ch=>({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    '"':"&quot;",
    "'":"&#039;"
  }[ch] || ch));
}

function renderAll(){
  inpTournament.value = state.tournamentName || "Évaluation Bac";
  tournamentNameEl.textContent = state.tournamentName || "Évaluation Bac";
  taStudents.value = state.students.map(s=>s.name).join("\n");
  if(state.courts.length){
    inpCourts.value = state.courts.length;
  }
  renderTimer();
  if(document.getElementById("page-setup").style.display !== "none"){
    renderCourtConfig();
  }
  if(document.getElementById("page-assign").style.display !== "none"){
    renderAssignmentsPage();
  }
  if(document.getElementById("page-matches").style.display !== "none"){
    renderCourtsLive();
    renderManualAdjust();
  }
  if(document.getElementById("page-results").style.display !== "none"){
    renderResults();
  }
  if(document.getElementById("page-doubles").style.display !== "none"){
    renderDoubleAssignments();
    renderDoubleCourts();
    renderDoubleResults();
  }
}
renderAll();
const initialHash = window.location.hash.replace("#","");
if(initialHash && ["home","setup","assign","matches","results","doubles"].includes(initialHash)){
  showPage(initialHash);
}
</script>
</body>
</html>
